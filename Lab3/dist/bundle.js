(()=>{"use strict";var e=function(){function e(e,r,t){this.id=this.generateId(),this.title=e,this.author=r,this.year=t,this.isBorrowed=!1}return e.prototype.generateId=function(){return"book_"+Date.now()+"_"+Math.floor(1e3*Math.random())},e.prototype.getTitle=function(){return this.title},e.prototype.getAuthor=function(){return this.author},e.prototype.getYear=function(){return this.year},e.prototype.borrow=function(e){this.isBorrowed=!0,this.borrowedBy=e,this.borrowedDate=new Date},e.prototype.return=function(){this.isBorrowed=!1,this.borrowedBy=void 0,this.borrowedDate=void 0},e}(),r=function(){function e(e,r){this.id=e,this.name=r,this.borrowedBooks=[]}return e.prototype.getId=function(){return this.id},e.prototype.getName=function(){return this.name},e.prototype.getBorrowedBooksCount=function(){return this.borrowedBooks.length},e.prototype.canBorrowMore=function(){return this.borrowedBooks.length<3},e.prototype.borrowBook=function(e){this.canBorrowMore()&&this.borrowedBooks.push(e)},e.prototype.returnBook=function(e){var r=this.borrowedBooks.indexOf(e);r>-1&&this.borrowedBooks.splice(r,1)},e}(),t=function(e,r,t){if(t||2===arguments.length)for(var o,n=0,s=r.length;n<s;n++)!o&&n in r||(o||(o=Array.prototype.slice.call(r,0,n)),o[n]=r[n]);return e.concat(o||Array.prototype.slice.call(r))},o=function(){function e(){this.items=[],this.items=[]}return e.prototype.add=function(e){this.items.push(e)},e.prototype.remove=function(e){e>=0&&e<this.items.length&&this.items.splice(e,1)},e.prototype.find=function(e){return this.items.find(e)},e.prototype.findAll=function(e){return e?this.items.filter(e):t([],this.items,!0)},e.prototype.findById=function(e){return this.items.find(function(r){return r.id===e})},e.prototype.getAll=function(){return t([],this.items,!0)},e.prototype.count=function(){return this.items.length},e.prototype.clear=function(){this.items=[]},e.prototype.update=function(e,r){e>=0&&e<this.items.length&&(this.items[e]=r)},e.prototype.findIndex=function(e){return this.items.findIndex(e)},e}(),n=function(){function e(){}return e.saveBooks=function(e){try{localStorage.setItem(this.BOOKS_KEY,JSON.stringify(e))}catch(e){console.error("Error saving books to localStorage:",e)}},e.loadBooks=function(){try{var e=localStorage.getItem(this.BOOKS_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Error loading books from localStorage:",e),[]}},e.saveUsers=function(e){try{localStorage.setItem(this.USERS_KEY,JSON.stringify(e))}catch(e){console.error("Error saving users to localStorage:",e)}},e.loadUsers=function(){try{var e=localStorage.getItem(this.USERS_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Error loading users from localStorage:",e),[]}},e.clearBooks=function(){try{localStorage.removeItem(this.BOOKS_KEY)}catch(e){console.error("Error clearing books from localStorage:",e)}},e.clearUsers=function(){try{localStorage.removeItem(this.USERS_KEY)}catch(e){console.error("Error clearing users from localStorage:",e)}},e.clearAll=function(){try{localStorage.removeItem(this.BOOKS_KEY),localStorage.removeItem(this.USERS_KEY)}catch(e){console.error("Error clearing localStorage:",e)}},e.BOOKS_KEY="library_books",e.USERS_KEY="library_users",e}(),s=function(){function t(){this.booksLibrary=new o,this.usersLibrary=new o,this.loadFromStorage()}return t.prototype.addBook=function(r,t,o){var n=new e(r,t,o);return this.booksLibrary.add(n),this.saveToStorage(),n},t.prototype.getBooks=function(){return this.booksLibrary.getAll()},t.prototype.findBookById=function(e){return this.booksLibrary.findById(e)},t.prototype.deleteBook=function(e){var r=this.findBookById(e);if(!r)return{success:!1,message:"Книгу не знайдено"};if(r.isBorrowed)return{success:!1,message:"Не можна видалити позичену книгу"};var t=this.booksLibrary.findIndex(function(r){return r.id===e});return-1!==t?(this.booksLibrary.remove(t),this.saveToStorage(),{success:!0,message:'Книга "'.concat(r.getTitle(),'" успішно видалена')}):{success:!1,message:"Помилка при видаленні книги"}},t.prototype.addUser=function(e,t){if(this.usersLibrary.findById(e))return null;var o=new r(e,t);return this.usersLibrary.add(o),this.saveToStorage(),o},t.prototype.getUsers=function(){return this.usersLibrary.getAll()},t.prototype.findUserById=function(e){return this.usersLibrary.findById(e)},t.prototype.deleteUser=function(e){var r=this.findUserById(e);if(!r)return{success:!1,message:"Користувача не знайдено"};if(r.getBorrowedBooksCount()>0)return{success:!1,message:"Не можна видалити користувача з позиченими книгами"};var t=this.usersLibrary.findIndex(function(r){return r.id===e});return-1!==t?(this.usersLibrary.remove(t),this.saveToStorage(),{success:!0,message:'Користувач "'.concat(r.getName(),'" успішно видалений')}):{success:!1,message:"Помилка при видаленні користувача"}},t.prototype.searchBooks=function(e){var r=e.toLowerCase().trim();return r?this.booksLibrary.findAll(function(e){return e.getTitle().toLowerCase().includes(r)||e.getAuthor().toLowerCase().includes(r)}):this.getBooks()},t.prototype.searchUsers=function(e){var r=e.toLowerCase().trim();return r?this.usersLibrary.findAll(function(e){return e.getName().toLowerCase().includes(r)||e.getId().toLowerCase().includes(r)}):this.getUsers()},t.prototype.borrowBook=function(e,r){var t=this.findBookById(e),o=this.findUserById(r);return t?o?t.isBorrowed?{success:!1,message:"Книга вже позичена"}:o.canBorrowMore()?(t.borrow(r),o.borrowBook(e),this.saveToStorage(),{success:!0,message:'Книга "'.concat(t.getTitle(),'" успішно позичена користувачу ').concat(o.getName())}):{success:!1,message:"Користувач вже позичив максимальну кількість книг (3)"}:{success:!1,message:"Користувача не знайдено"}:{success:!1,message:"Книгу не знайдено"}},t.prototype.returnBook=function(e){var r=this.findBookById(e);if(!r)return{success:!1,message:"Книгу не знайдено"};if(!r.isBorrowed||!r.borrowedBy)return{success:!1,message:"Книга не була позичена"};var t=this.findUserById(r.borrowedBy);t&&t.returnBook(e);var o=r.getTitle(),n=t?t.getName():"Невідомий";return r.return(),this.saveToStorage(),{success:!0,message:'Книга "'.concat(o,'" успішно повернута від користувача ').concat(n)}},t.prototype.loadFromStorage=function(){var t=this;n.loadBooks().forEach(function(r){var o=new e(r.title,r.author,r.year);o.id=r.id,o.isBorrowed=r.isBorrowed,o.borrowedBy=r.borrowedBy,r.borrowedDate&&(o.borrowedDate=new Date(r.borrowedDate)),t.booksLibrary.add(o)}),n.loadUsers().forEach(function(e){var o=new r(e.id,e.name);o.borrowedBooks=e.borrowedBooks||[],t.usersLibrary.add(o)})},t.prototype.saveToStorage=function(){n.saveBooks(this.booksLibrary.getAll()),n.saveUsers(this.usersLibrary.getAll())},t.prototype.clearAll=function(){this.booksLibrary.clear(),this.usersLibrary.clear(),n.clearAll()},t}(),i=function(){function e(){}return e.validateBookTitle=function(e){return e&&0!==e.trim().length?{isValid:!0}:{isValid:!1,error:"Назва книги обов'язкова"}},e.validateBookAuthor=function(e){return e&&0!==e.trim().length?{isValid:!0}:{isValid:!1,error:"Автор обов'язковий"}},e.validateBookYear=function(e){if(!e||0===e.trim().length)return{isValid:!1,error:"Рік видання обов'язковий"};if(!/^\d+$/.test(e))return{isValid:!1,error:"Рік має містити тільки цифри"};var r=parseInt(e,10),t=(new Date).getFullYear();return r<1e3||r>t?{isValid:!1,error:"Рік має бути між 1000 та ".concat(t)}:{isValid:!0}},e.validateUserName=function(e){return e&&0!==e.trim().length?{isValid:!0}:{isValid:!1,error:"Ім'я користувача обов'язкове"}},e.validateUserId=function(e){return e&&0!==e.trim().length?/^\d+$/.test(e)?{isValid:!0}:{isValid:!1,error:"ID має містити тільки цифри"}:{isValid:!1,error:"ID користувача обов'язковий"}},e.validateBookForm=function(e,r,t){var o={},n=this.validateBookTitle(e);!n.isValid&&n.error&&(o.title=n.error);var s=this.validateBookAuthor(r);!s.isValid&&s.error&&(o.author=s.error);var i=this.validateBookYear(t);return!i.isValid&&i.error&&(o.year=i.error),{isValid:0===Object.keys(o).length,errors:o}},e.validateUserForm=function(e,r){var t={},o=this.validateUserId(e);!o.isValid&&o.error&&(t.id=o.error);var n=this.validateUserName(r);return!n.isValid&&n.error&&(t.name=n.error),{isValid:0===Object.keys(t).length,errors:t}},e}(),a=function(){function e(){var e=document.getElementById("borrowModal"),r=document.getElementById("returnModal"),t=document.getElementById("alertModal");e&&(this.borrowModal=new window.bootstrap.Modal(e)),r&&(this.returnModal=new window.bootstrap.Modal(r)),t&&(this.alertModal=new window.bootstrap.Modal(t))}return e.prototype.showBorrowModal=function(e,r){var t=this;return new Promise(function(o){var n,s=document.getElementById("borrowMessage"),i=document.getElementById("userSelect"),a=document.getElementById("confirmBorrow");if(s&&i&&a){s.textContent='Ви хочете позичити книгу "'.concat(e,'"?'),i.innerHTML='<option value="">Оберіть користувача</option>',r.forEach(function(e){var r=document.createElement("option");r.value=e.id,r.textContent="".concat(e.name," (Позичено книг: ").concat(e.borrowedBooks.length,"/3)"),i.appendChild(r)});var c=function(){var e=i.value;a.removeEventListener("click",c),t.borrowModal.hide(),o(e||null)},l=function(){var e;a.removeEventListener("click",c),null===(e=document.getElementById("borrowModal"))||void 0===e||e.removeEventListener("hidden.bs.modal",l),o(null)};a.addEventListener("click",c),null===(n=document.getElementById("borrowModal"))||void 0===n||n.addEventListener("hidden.bs.modal",l)}t.borrowModal.show()})},e.prototype.showReturnModal=function(e,r){var t=this;return new Promise(function(o){var n,s=document.getElementById("returnMessage"),i=document.getElementById("confirmReturn");if(s&&i){s.textContent='Повернути книгу "'.concat(e,'" від користувача ').concat(r,"?");var a=function(){i.removeEventListener("click",a),t.returnModal.hide(),o(!0)},c=function(){var e;i.removeEventListener("click",a),null===(e=document.getElementById("returnModal"))||void 0===e||e.removeEventListener("hidden.bs.modal",c),o(!1)};i.addEventListener("click",a),null===(n=document.getElementById("returnModal"))||void 0===n||n.addEventListener("hidden.bs.modal",c)}t.returnModal.show()})},e.prototype.showAlert=function(e,r){void 0===r&&(r="Повідомлення");var t=document.getElementById("alertMessage"),o=document.querySelector("#alertModal .modal-title");t&&(t.textContent=e),o&&(o.textContent=r),this.alertModal.show()},e.prototype.showSuccess=function(e){this.showAlert(e,"Успіх")},e.prototype.showError=function(e){this.showAlert(e,"Помилка")},e.prototype.showWarning=function(e){this.showAlert(e,"Увага")},e}(),c=function(){function e(){this.selectedBook=null,this.currentBookPage=1,this.currentUserPage=1,this.itemsPerPage=5,this.bookSearchTerm="",this.userSearchTerm="",this.libraryService=new s,this.modal=new a,this.init()}return e.prototype.init=function(){this.setupEventListeners(),this.renderBooks(),this.renderUsers()},e.prototype.setupEventListeners=function(){var e=this,r=document.getElementById("addBookForm");r&&r.addEventListener("submit",function(r){return e.handleAddBook(r)});var t=document.getElementById("addUserForm");t&&t.addEventListener("submit",function(r){return e.handleAddUser(r)});var o=document.getElementById("bookSearch");o&&o.addEventListener("input",function(r){e.bookSearchTerm=r.target.value,e.currentBookPage=1,e.renderBooks()});var n=document.getElementById("userSearch");n&&n.addEventListener("input",function(r){e.userSearchTerm=r.target.value,e.currentUserPage=1,e.renderUsers()});var s=document.getElementById("clearBookSearch");s&&s.addEventListener("click",function(){e.bookSearchTerm="";var r=document.getElementById("bookSearch");r&&(r.value=""),e.currentBookPage=1,e.renderBooks()});var i=document.getElementById("clearUserSearch");i&&i.addEventListener("click",function(){e.userSearchTerm="";var r=document.getElementById("userSearch");r&&(r.value=""),e.currentUserPage=1,e.renderUsers()})},e.prototype.handleAddBook=function(e){e.preventDefault();var r=document.getElementById("bookTitle"),t=document.getElementById("bookAuthor"),o=document.getElementById("bookYear");if(r&&t&&o){var n=r.value.trim(),s=t.value.trim(),a=o.value.trim(),c=i.validateBookForm(n,s,a);if(this.clearFormErrors("addBookForm"),!c.isValid)return c.errors.title&&this.showFieldError(r,c.errors.title),c.errors.author&&this.showFieldError(t,c.errors.author),void(c.errors.year&&this.showFieldError(o,c.errors.year));var l=this.libraryService.addBook(n,s,parseInt(a,10));r.value="",t.value="",o.value="",this.currentBookPage=1,this.renderBooks(),this.modal.showSuccess('Книга "'.concat(l.getTitle(),'" успішно додана!'))}},e.prototype.handleAddUser=function(e){e.preventDefault();var r=document.getElementById("userName"),t=document.getElementById("userId");if(r&&t){var o=r.value.trim(),n=t.value.trim(),s=i.validateUserForm(n,o);if(this.clearFormErrors("addUserForm"),!s.isValid)return s.errors.name&&this.showFieldError(r,s.errors.name),void(s.errors.id&&this.showFieldError(t,s.errors.id));var a=this.libraryService.addUser(n,o);a?(r.value="",t.value="",this.currentUserPage=1,this.renderUsers(),this.modal.showSuccess("Користувач ".concat(a.getName()," успішно доданий!"))):this.showFieldError(t,"Користувач з таким ID вже існує")}},e.prototype.handleBookClick=function(e){return r=this,t=void 0,n=function(){var r,t,o,n;return function(e,r){var t,o,n,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=a(0),i.throw=a(1),i.return=a(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(t=1,o&&(n=2&a[0]?o.return:a[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,a[1])).done)return n;switch(o=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=r.call(e,s)}catch(e){a=[6,e],o=0}finally{t=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,function(s){switch(s.label){case 0:return e.isBorrowed?(o=this.libraryService.findUserById(e.borrowedBy||""))?[4,this.modal.showReturnModal(e.getTitle(),o.getName())]:[3,2]:[3,3];case 1:s.sent()&&((n=this.libraryService.returnBook(e.id)).success?(this.modal.showSuccess(n.message),this.renderBooks(),this.renderUsers()):this.modal.showError(n.message)),s.label=2;case 2:return[3,5];case 3:return 0===(r=this.libraryService.getUsers()).length?(this.modal.showWarning("Спочатку додайте користувачів!"),[2]):[4,this.modal.showBorrowModal(e.getTitle(),r)];case 4:if(t=s.sent()){if((o=this.libraryService.findUserById(t))&&!o.canBorrowMore())return this.modal.showWarning("Користувач ".concat(o.getName()," вже позичив максимальну кількість книг (3). Поверніть хоча б одну книгу перед тим як позичити нову.")),[2];(n=this.libraryService.borrowBook(e.id,t)).success?(this.modal.showSuccess(n.message),this.renderBooks(),this.renderUsers()):this.modal.showError(n.message)}s.label=5;case 5:return[2]}})},new((o=void 0)||(o=Promise))(function(e,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(r){var t;r.done?e(r.value):(t=r.value,t instanceof o?t:new o(function(e){e(t)})).then(i,a)}c((n=n.apply(r,t||[])).next())});var r,t,o,n},e.prototype.handleDeleteBook=function(e){if(confirm('Видалити книгу "'.concat(e.getTitle(),'"?'))){var r=this.libraryService.deleteBook(e.id);r.success?(this.modal.showSuccess(r.message),this.renderBooks()):this.modal.showError(r.message)}},e.prototype.handleDeleteUser=function(e){if(confirm('Видалити користувача "'.concat(e.getName(),'"?'))){var r=this.libraryService.deleteUser(e.id);r.success?(this.modal.showSuccess(r.message),this.renderUsers()):this.modal.showError(r.message)}},e.prototype.renderBooks=function(){var e=this,r=document.getElementById("booksList"),t=document.getElementById("booksPagination");if(r&&t){var o=this.libraryService.getBooks();this.bookSearchTerm&&(o=this.libraryService.searchBooks(this.bookSearchTerm));var n=o.length,s=Math.ceil(n/this.itemsPerPage);this.currentBookPage>s&&s>0&&(this.currentBookPage=s);var i=(this.currentBookPage-1)*this.itemsPerPage,a=i+this.itemsPerPage,c=o.slice(i,a);if(0===c.length){var l=this.bookSearchTerm?'<p class="text-muted text-center">Книги за вашим запитом не знайдено</p>':'<p class="text-muted text-center">Немає доданих книг</p>';r.innerHTML=l}else r.innerHTML="",c.forEach(function(t){var o=document.createElement("div");o.className="col-md-4 mb-3";var n=t.isBorrowed,s=t.borrowedBy?e.libraryService.findUserById(t.borrowedBy):null;o.innerHTML='\n                    <div class="card book-card '.concat(n?"borrowed":"",'" style="position: relative;">\n                        ').concat(n?'<span class="badge bg-danger badge-borrowed">Позичена</span>':"",'\n                        <div class="card-body">\n                            <h6 class="card-title">').concat(t.getTitle(),'</h6>\n                            <p class="card-text">\n                                <small class="text-muted">Автор: ').concat(t.getAuthor(),'</small><br>\n                                <small class="text-muted">Рік: ').concat(t.getYear(),"</small>\n                                ").concat(n&&s?'<br><small class="text-danger">Позичив: '.concat(s.getName(),"</small>"):"",'\n                            </p>\n                            <div class="d-flex gap-2">\n                                <button class="btn btn-sm ').concat(n?"btn-warning":"btn-primary",' flex-grow-1 borrow-btn">\n                                    ').concat(n?"Повернути":"Позичити",'\n                                </button>\n                                <button class="btn btn-sm btn-outline-danger delete-btn" title="Видалити книгу">\n                                    <i class="bi bi-trash"></i>\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                ');var i=o.querySelector(".borrow-btn"),a=o.querySelector(".delete-btn");i&&i.addEventListener("click",function(){return e.handleBookClick(t)}),a&&a.addEventListener("click",function(){return e.handleDeleteBook(t)}),r.appendChild(o)});this.renderPagination(t,this.currentBookPage,s,"book")}},e.prototype.renderUsers=function(){var e=this,r=document.getElementById("usersList"),t=document.getElementById("usersPagination");if(r&&t){var o=this.libraryService.getUsers();this.userSearchTerm&&(o=this.libraryService.searchUsers(this.userSearchTerm));var n=o.length,s=Math.ceil(n/this.itemsPerPage);this.currentUserPage>s&&s>0&&(this.currentUserPage=s);var i=(this.currentUserPage-1)*this.itemsPerPage,a=i+this.itemsPerPage,c=o.slice(i,a);if(0===c.length){var l=this.userSearchTerm?'<p class="text-muted text-center">Користувачі за вашим запитом не знайдені</p>':'<p class="text-muted text-center">Немає доданих користувачів</p>';r.innerHTML=l}else r.innerHTML="",c.forEach(function(t){var o=document.createElement("div");o.className="col-md-4 mb-3";var n=t.getBorrowedBooksCount(),s=t.canBorrowMore();o.innerHTML='\n                    <div class="card user-card">\n                        <div class="card-body">\n                            <h6 class="card-title">'.concat(t.getName(),'</h6>\n                            <p class="card-text">\n                                <small class="text-muted">ID: ').concat(t.getId(),'</small><br>\n                                <span class="badge ').concat(s?"bg-success":"bg-danger",'">\n                                    Позичено книг: ').concat(n,'/3\n                                </span>\n                            </p>\n                            <button class="btn btn-sm btn-outline-danger w-100 delete-user-btn" ').concat(n>0?"disabled":"",">\n                                ").concat(n>0?"Не можна видалити (є позичені книги)":"Видалити","\n                            </button>\n                        </div>\n                    </div>\n                ");var i=o.querySelector(".delete-user-btn");i&&0===n&&i.addEventListener("click",function(){return e.handleDeleteUser(t)}),r.appendChild(o)});this.renderPagination(t,this.currentUserPage,s,"user")}},e.prototype.renderPagination=function(e,r,t,o){var n=this;if(t<=1)e.innerHTML="";else{var s='\n            <nav aria-label="Page navigation">\n                <ul class="pagination pagination-sm justify-content-center">\n        ';s+='\n            <li class="page-item '.concat(1===r?"disabled":"",'">\n                <a class="page-link" href="#" data-page="').concat(r-1,'">Попередня</a>\n            </li>\n        ');for(var i=1;i<=t;i++)s+='\n                <li class="page-item '.concat(i===r?"active":"",'">\n                    <a class="page-link" href="#" data-page="').concat(i,'">').concat(i,"</a>\n                </li>\n            ");s+='\n            <li class="page-item '.concat(r===t?"disabled":"",'">\n                <a class="page-link" href="#" data-page="').concat(r+1,'">Наступна</a>\n            </li>\n        '),s+="\n                </ul>\n            </nav>\n        ",e.innerHTML=s,e.querySelectorAll(".page-link").forEach(function(e){e.addEventListener("click",function(r){r.preventDefault();var t=parseInt(e.getAttribute("data-page")||"1");"book"===o?(n.currentBookPage=t,n.renderBooks()):(n.currentUserPage=t,n.renderUsers())})})}},e.prototype.showFieldError=function(e,r){var t;e.classList.add("is-invalid");var o=null===(t=e.parentElement)||void 0===t?void 0:t.querySelector(".invalid-feedback");o&&(o.textContent=r)},e.prototype.clearFormErrors=function(e){var r=document.getElementById(e);r&&r.querySelectorAll(".form-control").forEach(function(e){e.classList.remove("is-invalid")})},e}();document.addEventListener("DOMContentLoaded",function(){new c})})();